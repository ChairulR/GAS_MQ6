#include <WiFi.h>
#include <HTTPClient.h>
#include <DHTesp.h>

// ========== PIN SETUP ==========
const int DHT_PIN     = 25;
const int MQ6_AO      = 34;
const int BUZZER_PIN  = 14;

// ========== WiFi ==========
const char* ssid = "";
const char* password = "";

// ========== API ==========
const char* API_URL = "";
const char* PHONE_NUMBER = "";

// ========== GLOBAL VAR ==========
DHTesp dht;
unsigned long lastSendTime = 0;
const unsigned long sendInterval = 7200000; // 2 jam (ms)
const int GAS_THRESHOLD = 1000;

void setup() {
  Serial.begin(115200);

  pinMode(BUZZER_PIN, OUTPUT);
  digitalWrite(BUZZER_PIN, LOW);

  dht.setup(DHT_PIN, DHTesp::DHT22);

  Serial.println("Memanaskan sensor MQ6...");
  delay(5000);
  Serial.println("Sensor MQ6 siap.");

  WiFi.begin(ssid, password);
  Serial.print("Menghubungkan WiFi");
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }
  Serial.println("\nâœ… WiFi Tersambung! IP: " + WiFi.localIP().toString());
}

void sendWhatsAppMessage(String message) {
  if (WiFi.status() == WL_CONNECTED) {
    HTTPClient http;
    http.begin("");
    http.addHeader("Content-Type", "application/json");

    // Escape karakter spesial
    message.replace("\"", "\\\"");
    message.replace("\n", "\\n");

    // Tambahkan number ke payload
    String payload = "{\"number\": \"" + String("") + "\", \"message\": \"" + message + "\"}";

    Serial.println("Payload: " + payload); // Debug

    int responseCode = http.POST(payload);

    Serial.println("HTTP Response: " + String(responseCode));
    if (responseCode > 0) {
      String response = http.getString();
      Serial.println("Response: " + response);
    } else {
      Serial.println("âŒ Gagal kirim pesan: " + http.errorToString(responseCode));
    }

    http.end();
  } else {
    Serial.println("âŒ WiFi tidak terhubung!");
  }
}

void loop() {
  TempAndHumidity data = dht.getTempAndHumidity();

  if (isnan(data.temperature) || isnan(data.humidity)) {
    Serial.println("âŒ Data DHT tidak valid.");
    delay(5000);
    return;
  }

  float temp = data.temperature;
  float hum = data.humidity;

  int mqAnalog = analogRead(MQ6_AO);
  String gasStatus = (mqAnalog > 1000) ? "Berbahaya" : "Aman";

  Serial.printf("ðŸŒ¡ Temp: %.2f Â°C | ðŸ’§ Hum: %.2f %% | ðŸ§ª Gas Analog: %d | âš  Status: %s\n",
                temp, hum, mqAnalog, gasStatus.c_str());

  if (mqAnalog > 1000) {
    digitalWrite(BUZZER_PIN, HIGH);
        String message = String("ðŸ“¡ *Data Monitoring:*\n") +
        "ðŸŒ¡ *Temperature:* " + String(temp, 2) + "Â°C\n" +
        "ðŸ’§ *Humidity:* " + String(hum, 1) + "%\n" +
        "ðŸ§ª *Gas Analog:* " + String(mqAnalog) + "\n" +
        "âš  *Gas Status:* " + gasStatus;

    sendWhatsAppMessage(message);
    if (millis() - lastSendTime > sendInterval) {  
      lastSendTime = millis();
    }

  } else {
    digitalWrite(BUZZER_PIN, LOW);
  }

  delay(5000);
}
